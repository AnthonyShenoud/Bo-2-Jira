#!/usr/bin/env bash
set -e

echo "â–¶ï¸ Starting Jira Sync..."

# Environment Variables
JIRA_BASE_URL="https://$JIRA_DOMAIN"
echo "â–¶ï¸ Jira Base URL: $JIRA_BASE_URL"

# Extract info from GitHub event
issue_title=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
issue_body=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
labels=$(jq -r '[.issue.labels[].name] | join(",")' "$GITHUB_EVENT_PATH")

echo "â–¶ï¸ Issue Title: $issue_title"
echo "â–¶ï¸ Issue Body: $issue_body"
echo "â–¶ï¸ Labels: $labels"

# Extract Jira key from title
if [[ "$issue_title" =~ ([A-Z]+-[0-9]+) ]]; then
  jira_key="${BASH_REMATCH[1]}"
  echo "ğŸ”— Found Jira key in title: $jira_key"
else
  echo "âŒ No Jira issue key found in title."
  exit 0
fi

# Build payload for Jira update
payload=$(jq -n \
  --arg summary "$issue_title" \
  --arg desc "$issue_body" \
  '{ fields: { summary: $summary, description: $desc } }')

echo "ğŸ“¦ Payload to send to Jira:"
echo "$payload" | jq

# Print Authorization Header (masked)
auth_header=$(echo -n "$JIRA_USER:$JIRA_API_TOKEN" | base64)
echo "ğŸ” Using Auth Header: (base64-encoded) $auth_header"

# PUT request to update Jira issue
echo "ğŸ“¡ Sending PUT request to: $JIRA_BASE_URL/rest/api/3/issue/$jira_key"
response=$(curl -v -w "%{http_code}" -o response.json -X PUT \
  -H "Authorization: Basic $auth_header" \
  -H "Content-Type: application/json" \
  --data "$payload" \
  "$JIRA_BASE_URL/rest/api/3/issue/$jira_key")

# Separate HTTP status code from response body
http_status="${response: -3}"  # last 3 chars
echo "ğŸ§¾ HTTP Status Code: $http_status"
echo "ğŸ“¥ Jira Response Body:"
cat response.json
echo ""

# Check if the request failed
if [[ "$http_status" -ge 400 ]]; then
  echo "âŒ Failed to update Jira issue $jira_key. Status code: $http_status"
  exit 43
else
  echo "âœ… Jira issue updated successfully."
fi

# Handle issue transition based on labels
transition_id=""
if [[ "$labels" == *"done"* ]]; then
  transition_id=31
elif [[ "$labels" == *"inprogress"* ]]; then
  transition_id=21
elif [[ "$labels" == *"inreview"* ]]; then
  transition_id=2
elif [[ "$labels" == *"todo"* ]]; then
  transition_id=11
elif [[ "$labels" == *"backlog"* ]]; then
  transition_id=3
fi

if [[ -n "$transition_id" ]]; then
  echo "ğŸ”„ Transitioning Jira issue $jira_key to ID $transition_id..."
  transition_response=$(curl -v -X POST \
    -H "Authorization: Basic $auth_header" \
    -H "Content-Type: application/json" \
    --data "{ \"transition\": { \"id\": \"$transition_id\" } }" \
    "$JIRA_BASE_URL/rest/api/3/issue/$jira_key/transitions")

  echo "ğŸ“¤ Transition response:"
  echo "$transition_response"
  echo "âœ… Transition applied."
fi
