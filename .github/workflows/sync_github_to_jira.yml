name: Sync GitHub Issues to Jira

on:
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync GitHub issue/comment to Jira
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_DOMAIN: anthonyashenouda.atlassian.net
        run: |
          echo "ğŸ“¦ Reading GitHub event..."

          if [[ -f "$GITHUB_EVENT_PATH" ]]; then
            event_type=$(jq -r '.comment | if . == null then "issue" else "comment" end' "$GITHUB_EVENT_PATH")
          else
            echo "âŒ GITHUB_EVENT_PATH not found."
            exit 1
          fi

          if [[ "$event_type" == "comment" ]]; then
            issue_title=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
            issue_body=$(jq -r '.comment.body' "$GITHUB_EVENT_PATH")
            echo "ğŸ“Œ Issue Title: $issue_title"
            echo "ğŸ’¬ Comment Body: $issue_body"
          else
            issue_title=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
            issue_body=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
            echo "ğŸ“Œ Issue Title: $issue_title"
            echo "ğŸ“Œ Issue Body: $issue_body"
          fi

          if [[ "$issue_title" =~ ([A-Z]+-[0-9]+) ]]; then
            jira_key="${BASH_REMATCH[1]}"
            echo "ğŸ”— Found Jira key: $jira_key"
          else
            echo "âŒ No Jira issue key found in title."
            exit 0
          fi

          JIRA_BASE_URL="https://$JIRA_DOMAIN"
          jira_url="$JIRA_BASE_URL/rest/api/3/issue/$jira_key/comment"
          echo "ğŸŒ Jira URL: $jira_url"

          auth_header=$(echo -n "$JIRA_USER:$JIRA_API_TOKEN" | base64)
          echo "ğŸ” Encoded Auth Header created."

          payload=$(jq -n \
            --arg body "$issue_body" \
            '{ body: $body }')

          echo "ğŸ“¤ Payload to send:"
          echo "$payload"

          echo "ğŸ’¬ Posting comment to Jira..."
          response_file="response.json"
          http_status=$(curl -s -w "%{http_code}" -o "$response_file" -X POST \
            -H "Authorization: Basic $auth_header" \
            -H "Content-Type: application/json" \
            --data "$payload" \
            "$jira_url")

          echo "ğŸ“¥ HTTP Status: $http_status"
          echo "ğŸ“¨ Jira Response:"
          cat "$response_file" || echo "(empty)"

          if [[ "$http_status" -ge 400 ]]; then
            echo "âŒ Jira update failed with HTTP status $http_status"
            exit 43
          else
            echo "âœ… Jira issue updated successfully."
          fi

            exit 0
          fi

          # If we're here, it's an issue event
          issue_title=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          issue_body=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          labels=$(jq -r '[.issue.labels[].name] | join(",")' "$GITHUB_EVENT_PATH")

          echo "ğŸ“Œ Issue Title: $issue_title"
          echo "ğŸ“Œ Issue Body: $issue_body"
          echo "ğŸ·ï¸ Labels: $labels"

          if [[ "$issue_title" =~ ([A-Z]+-[0-9]+) ]]; then
            jira_key="${BASH_REMATCH[1]}"
            echo "ğŸ”— Found Jira key: $jira_key"
          else
            echo "âŒ No Jira issue key found in title."
            exit 0
          fi

          jira_url="$JIRA_BASE_URL/rest/api/3/issue/$jira_key"
          payload=$(jq -n \
            --arg summary "$issue_title" \
            --arg desc "$issue_body" \
            '{ fields: { summary: $summary, description: $desc } }')

          echo "ğŸ“¤ Updating Jira issue fields..."
          http_status=$(curl -s -w "%{http_code}" -o response.json -X PUT \
            -H "Authorization: Basic $auth_header" \
            -H "Content-Type: application/json" \
            --data "$payload" \
            "$jira_url")

          echo "ğŸ“¥ HTTP Status: $http_status"
          cat response.json || echo "(empty)"

          if [[ "$http_status" -ge 400 ]]; then
            echo "âŒ Jira update failed with HTTP status $http_status"
            exit 43
          else
            echo "âœ… Jira issue updated successfully."
          fi

          # Optional transitions
          transition_id=""
          if [[ "$labels" == *"done"* ]]; then
            transition_id=31
          elif [[ "$labels" == *"inprogress"* ]]; then
            transition_id=21
          elif [[ "$labels" == *"inreview"* ]]; then
            transition_id=2
          elif [[ "$labels" == *"todo"* ]]; then
            transition_id=11
          elif [[ "$labels" == *"backlog"* ]]; then
            transition_id=3
          fi

          if [[ -n "$transition_id" ]]; then
            echo "ğŸ”„ Transitioning Jira issue $jira_key to ID $transition_id..."
            curl -s -X POST \
              -H "Authorization: Basic $auth_header" \
              -H "Content-Type: application/json" \
              --data "{ \"transition\": { \"id\": \"$transition_id\" } }" \
              "$JIRA_BASE_URL/rest/api/3/issue/$jira_key/transitions"
            echo "âœ… Transition applied."
          fi
